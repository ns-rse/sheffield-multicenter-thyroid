The [MICE][mice] package offers a number of different methods for imputing variables (see [documentation][mice_details])
we have investigated Predictive Mean Matching (PMM), Classification and Regression Trees (CART) and Random Forests
(RF). Four rounds of imputation using each method were made.

A comparison of distributions/proportions before and after imputation are presented below to allow assessment of the
utility of each method.


```{r}
#| label: mice-imputation
#| eval: true
#| echo: false
#| output: false
#| cache: true
## Setup MICE mids for various methods
##
## It might be worth reading
## Predictive Mean Matching
imputations = 4
cores = imputations
mice_pmm <- df_complete |>
    dplyr::select(-final_pathology) |>    ## We deliberately exclude the outcome of interest
    mice::futuremice(m = imputations, method="pmm", n.core=cores) |>
    mice::complete(action = "long", include = TRUE)
mice_pmm <- dplyr::mutate(mice_pmm, .imp = factor(.imp, levels = c(0,1,2,3,4), labels = c("Original", "1", "2", "3", "4")))

## CART (Classification And Regression Trees)
mice_cart <- df_complete |>
    dplyr::select(-final_pathology) |>    ## We deliberately exclude the outcome of interest
    mice::futuremice(m = imputations, method="cart", n.core=cores) |>
    mice::complete(action = "long", include = TRUE)
mice_cart <- dplyr::mutate(mice_cart, .imp = factor(.imp, levels = c(0,1,2,3,4), labels = c("Original", "1", "2", "3", "4")))

## Random Forest
mice_rf <- df_complete |>
    dplyr::select(-final_pathology) |>    ## We deliberately exclude the outcome of interest
    mice::futuremice(m = imputations, method="rf", n.core=cores) |>
    mice::complete(action = "long", include = TRUE)
mice_rf <- dplyr::mutate(mice_rf, .imp = factor(.imp, levels = c(0,1,2,3,4), labels = c("Original", "1", "2", "3", "4")))


## Define two functions for plotting
#' Plot histograms of a continuous variable in original and imputed data sets.
#'
#' @param original data.frame|tibble The original data frame.
#' @param pmm mice MICE object from Predictive Mean Modelling.
#' @param cart mice MICE object from CART.
#' @param rf mice MICE object from Random Forest.
#' @param to_plot str Variable to plot, should be a continuous variable for histograms.
#' @param imputation int The immputation set to plot.
#' @param format str The "action" option used in 'mice_complete()', either "all" or "long" are supported.
#' @param colours list A list of length four of colours to use when plotting.
plot_imputed_hist <- function(original, pmm, cart, rf,
                              to_plot,
                              imputation = 1,
                              format = "long",
                              colours = c("#ad1538", "#15ad4f", "#1543ad", "#ad8415")) {
    if (format == "all") {
        df <- data.frame(original = original[to_plot],
                     pmm = pmm[[imputation]][to_plot],
                     cart = cart[[imputation]][to_plot],
                     rf = rf[[imputation]][to_plot])
    }
    if (format == "long") {
        df <- data.frame(original = original[to_plot],
                     pmm = pmm |> dplyr::filter(.imp == imputation) |> dplyr::select(to_plot),
                     cart = cart |> dplyr::filter(.imp == imputation) |> dplyr::select(to_plot),
                     rf = rf |> dplyr::filter(.imp == imputation) |> dplyr::select(to_plot))
    }
    colnames(df) <- c("original", "pmm", "cart", "rf")
    hist_obs <- df |>
        ggplot2::ggplot(aes(original)) +
        ggplot2::geom_histogram(fill = colours[1], color = "#000000", position = "identity") +
        ggplot2::ggtitle("Original") +
        ggplot2::theme(axis.title.x = element_blank())
    hist_pmm <- df |>
        ggplot2::ggplot(aes(pmm)) +
        ggplot2::geom_histogram(fill = colours[2], color = "#000000", position = "identity") +
        ggplot2::ggtitle("PMM-imputed") +
        ggplot2::theme(axis.title.x = element_blank())
    hist_cart <- df |>
        ggplot2::ggplot(aes(cart)) +
        ggplot2::geom_histogram(fill = colours[3], color = "#000000", position = "identity") +
        ggplot2::ggtitle("CART-imputed") +
        ggplot2::theme(axis.title.x = element_blank())
    hist_rf <- df |>
        ggplot2::ggplot(aes(rf)) +
        ggplot2::geom_histogram(fill = colours[4], color = "#000000", position = "identity") +
        ggplot2::ggtitle("RF-imputed") +
        ggplot2::theme(axis.title.x = element_blank())
    cowplot::plot_grid(hist_obs, hist_pmm, hist_cart, hist_rf, nrow = 2, ncol = 2)
}

#' Plot bar charts of a categorical variable in original and imputed data sets.
#'
#' @param original data.frame|tibble The original data frame.
#' @param pmm mice MICE object from Predictive Mean Modelling.
#' @param cart mice MICE object from CART.
#' @param rf mice MICE object from Random Forest.
#' @param to_plot str Variable to plot, should be a continuous variable for histograms.
#' @param imputation int The immputation set to plot.
#' @param format str The "action" option used in 'mice_complete()', either "all" or "long" are supported.
#' @param colours list A list of length four of colours to use when plotting.
plot_imputed_cat <- function(original, pmm, cart, rf,
                             to_plot,
                             imputation = 1,
                             format = "long",
                             colours = c("#ad1538", "#15ad4f", "#1543ad", "#ad8415")) {
    if (format == "all") {
        df <- data.frame(original = original[to_plot],
                     pmm = pmm[[imputation]][to_plot],
                     cart = cart[[imputation]][to_plot],
                     rf = rf[[imputation]][to_plot])
    }
    if (format == "long") {
        df <- data.frame(original = original[to_plot],
                     pmm = pmm |> dplyr::filter(.imp == imputation) |> dplyr::select(to_plot),
                     cart = cart |> dplyr::filter(.imp == imputation) |> dplyr::select(to_plot),
                     rf = rf |> dplyr::filter(.imp == imputation) |> dplyr::select(to_plot))
    }
    colnames(df) <- c("original", "pmm", "cart", "rf")
    bar_obs <- df |>
        dplyr::filter(!is.na(original)) |>
        ggplot2::ggplot(aes(original)) +
        ggplot2::geom_bar(fill = colours[1], color = "#000000", position = "identity") +
        ggplot2::ggtitle("Original") +
        ggplot2::theme(axis.title.x = element_blank())
    bar_pmm <- df |>
        ggplot2::ggplot(aes(pmm)) +
        ggplot2::geom_bar(fill = colours[2], color = "#000000", position = "identity") +
        ggplot2::ggtitle("PMM-imputed") +
        ggplot2::theme(axis.title.x = element_blank())
    bar_cart <- df |>
        ggplot2::ggplot(aes(cart)) +
        ggplot2::geom_bar(fill = colours[3], color = "#000000", position = "identity") +
        ggplot2::ggtitle("CART-imputed") +
        ggplot2::theme(axis.title.x = element_blank())
    bar_rf <- df |>
        ggplot2::ggplot(aes(rf)) +
        ggplot2::geom_bar(fill = colours[4], color = "#000000", position = "identity") +
        ggplot2::ggtitle("RF-imputed") +
        ggplot2::theme(axis.title.x = element_blank())
    cowplot::plot_grid(bar_obs, bar_pmm, bar_cart, bar_rf, nrow = 2, ncol = 2)
}

```



::: {.panel-tabset}

## Albumin

```{r}
#| label: fig-mice-imputation-albumin
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_hist(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "albumin",
                  format = "long",
                  imputation = 1)
```

## Monocyte

```{r}
#| label: fig-mice-imputation-monocyte
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_hist(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "monocyte",
                  format = "long",
                  imputation = 1)

```

## Lymphocytes

```{r}
#| label: fig-mice-imputation-lymphocytes
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_hist(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "lymphocytes",
                  format = "long",
                  imputation = 1)

```

## TSH Value

```{r}
#| label: fig-mice-imputation-tsh-value
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_hist(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "tsh_value",
                  format = "long",
                  imputation = 1)

```

## Nodule Size

```{r}
#| label: fig-mice-imputation-size-nodule-mm
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_hist(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "size_nodule_mm",
                  format = "long",
                  imputation = 1)

```

:::


::: {.panel-tabset}

## Incidental Nodule

```{r}
#| label: fig-mice-imputation-incidental-nodule
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "incidental_nodule",
                  format = "long",
                  imputation = 1)

```

## Palpable Nodule

```{r}
#| label: fig-mice-imputation-palpable-nodule
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "palpable_nodule",
                  format = "long",
                  imputation = 1)

```

## Rapid Enlargement

```{r}
#| label: fig-mice-imputation-rapid-enlargement
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "rapid_enlargement",
                  format = "long",
                  imputation = 1)

```

## Compressive Symptoms

```{r}
#| label: fig-mice-imputation-compressive-symptoms
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "compressive_symptoms",
                  format = "long",
                  imputation = 1)

```

## Hypertension

```{r}
#| label: fig-mice-imputation-hypertension
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "hypertension",
                  format = "long",
                  imputation = 1)

```

## Vocal Cord Paresis

```{r}
#| label: fig-mice-imputation-vocal-cord-paresis
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "vocal_cord_paresis",
                  format = "long",
                  imputation = 1)

```

## Graves Disease

```{r}
#| label: fig-mice-imputation-graves-disease
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "graves_disease",
                  format = "long",
                  imputation = 1)

```

## Hashimotos Thyroiditis

```{r}
#| label: fig-mice-imputation-hashimotos-thyroiditis
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "hashimotos_thyroiditis",
                  format = "long",
                  imputation = 1)

```

## Family History

```{r}
#| label: fig-mice-imputation-family-history-thyroid-cancer
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "family_history_thyroid_cancer",
                  format = "long",
                  imputation = 1)

```

## Exposure Radiation

```{r}
#| label: fig-mice-imputation-exposure-radiation
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "exposure_radiation",
                  format = "long",
                  imputation = 1)

```

## Solitary Nodule

```{r}
#| label: fig-mice-imputation-solitary-nodule
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "solitary_nodule",
                  format = "long",
                  imputation = 1)

```

## BTA U-Classification

```{r}
#| label: fig-mice-imputation-bta-u-classification
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "bta_u_classification",
                  format = "long",
                  imputation = 1)

```

## Cervical Lymphadenopathy

```{r}
#| label: fig-mice-imputation-rapid-cervical-lymphadenopathy
#| purl: true
#| eval: true
#| echo: false
#| output: true
#| out-width: "80%"
plot_imputed_cat(original = df_complete,
                  pmm = mice_pmm,
                  cart = mice_cart,
                  rf = mice_rf,
                  to_plot = "cervical_lymphadenopathy",
                  format = "long",
                  imputation = 1)

```



:::


::: {.panel-tabset}

## PMM

```{r}
#| label: tbl-imputation-summary-pmm
#| tbl-caption: Summary of data imputed via PMM.
#| purl: true
#| eval: true
#| echo: false
#| output: true
mice_pmm |> gtsummary::tbl_summary(by=".imp")
```

## CART

```{r}
#| label: tbl-imputation-summary-cart
#| tbl-caption: Summary of data imputed via CART.
#| purl: true
#| eval: true
#| echo: false
#| output: true
mice_cart |> gtsummary::tbl_summary(by=".imp")

```

## RF

```{r}
#| label: tbl-imputation-summary-rf
#| tbl-caption: Summary of data imputed via Random Forest.
#| purl: true
#| eval: true
#| echo: false
#| output: true
mice_rf |> gtsummary::tbl_summary(by=".imp")
```

:::

[mice]: https://amices.org/mice/
[mice_detail]: https://amices.org/mice/reference/mice.html#details
